<% @title = "Email Subscriptions" %>
<% @welcome_image = "awon.png" %>

<script>
  subscriber_id = <%= @subscriber.id %>
  site_count = <%= @site_count %>
  min_lat = <%= latitudes.min %>
  max_lat = <%= latitudes.max %>
  min_long = <%= longitudes.min %>
  max_long = <%= longitudes.max %>

  function getGeoLocation() {
    navigator.geolocation.getCurrentPosition((position) => {
      let lat = position.coords.latitude.toFixed(1)
      let long = position.coords.longitude.toFixed(1)
      $("#location-display").html("Your closest lat/long coordinates are: " + lat + ", " + long)
    })
  }
  
  function validateName(site_name) {
    return $.trim(site_name)
  }

  function validateLat(lat) {
    if (!$.isNumeric(lat)) return false
    let lat_num = parseFloat(lat)
    return (lat_num >= min_lat && lat_num <= max_lat)
  }

  function validateLong(long) {
    if (!$.isNumeric(long)) return false
    let long_num = parseFloat(long)
    return (long_num >= min_long && long_num <= max_long)
  }

  function validate(site_name, lat, long) {
    let validations = []
    if (!validateName(site_name))
      validations.push("Invalid site name.")
    if (!validateLat(lat))
      validations.push("Invalid latitude. Must be a number between " + min_lat + " and " + max_lat)
    if (!validateLong(long))
      validations.push("Invalid longitude. Must be a number between " + min_long + " and " + max_long)
    return validations
  }

  $(document).ready(() => {
    // Enable the 'send email' button after 5 seconds
    if (site_count > 0) {
      setTimeout(() => {$("#send-email").prop("disabled", false)}, 5000)
    }

    // Handle add site button
    $("#submit-site").click((event) => {
      let site_name = $("#site-name").val()
      let lat = $("#latitude").val()
      let long = $("#longitude").val()
      let valid = validate(site_name, lat, long)

      if (valid.length > 0) {
        alert(valid.join("\n"))
        return false
      }

      $.ajax({
        type: "POST",
        url:  "<%= url_for(add_site_subscriber_path(@subscriber.id)) %>",
        data: {
          site_name: site_name,
          latitude: parseFloat(lat).toFixed(1),
          longitude: parseFloat(long).toFixed(1),
          to_edit_id: subscriber_id
        }
      }).success((data) => {
        data.id ? window.location.reload() : alert(data.message)
      })
    })

    // Allow enter key to trigger add
    $('#add-controls').keypress((k) => {
      if (k.which == 13) {
        $("#submit-site").click()
        return false
      }
    })

    // Handle delete site button
    $("[id^=delete-site]").click((event) => {
      if (!confirm("Are you sure you want to delete this site?")) return
      let site_id = $(event.target).closest("tr").data("site-id")
      let parent_row = $(event.target).closest("tr")
      $.ajax({
        type: "POST",
        url: "<%= url_for(remove_site_subscriber_path(@subscriber.id)) %>",
        data: {
          site_id: site_id,
          to_edit_id: subscriber_id
        }
      }).success((data) => {
        if (data.message == "success")
          window.location.reload()
        else
          alert("Unable to delete site, try reloading the page.")
      })
    })

    // Handle enable/disable checkboxes for sites
    $("[id^=site-toggle]").change((event) => {
      let site_id = $(event.target).closest("tr").data("site-id")
      let url
      if (event.target.checked) {
        url = "<%= url_for(enable_site_subscriber_path(@subscriber.id)) %>"
      } else {
        url = "<%= url_for(disable_site_subscriber_path(@subscriber.id)) %>"
      }
      $.ajax({
        type: "POST",
        url: url,
        data: {
          site_id: site_id,
          to_edit_id: subscriber_id
        }
      }).success((data) => {
        $("#notice").fadeOut()
        let div = $("#site-status-" + site_id)
        data.message == "enabled" ? div.html("Yes") : div.html("No")
      })
    })

    // Handle enable/disable checkboxes for subscriptions
    $("[id^=sub-toggle]").change((event) => {
      let site_id = $(event.target).closest("tr").data("site-id")
      let sub_id = $(event.target).val()
      let url
      if (event.target.checked) {
        url = "<%= url_for(enable_subscription_subscriber_path(@subscriber.id)) %>"
      } else {
        url = "<%= url_for(disable_subscription_subscriber_path(@subscriber.id)) %>"
      }
      $.ajax({
        type: "POST",
        url: url,
        data: {
          to_edit_id: subscriber_id,
          site_id: site_id,
          sub_id: sub_id
        }
      }).success((data) => {
        $("#notice").fadeOut()
      })
    })
  })
</script>

<% content_for :welcome do %>
  <h2><%= @title %></h2>
  <p>Add, remove, or manage your email subscriptions here.</p>
<% end %>

<h2>Automated daily emails</h2>

<hr>

<% if @subscriber.id != session[:subscriber] %>
  <p class="alert">ADMIN: You are editing another user's subscriptions.</p>
<% end %>

<b>Name: </b><%= @subscriber.name %><br>
<b>Email: </b><%= @subscriber.email %>

<p>Each morning you can receive email updates for up to 15 locations across our data coverage area. For each site we report the past week of daily high/low temperatures, precipitation, and potential evapotranspiration.</p>

<p>To add a site, enter a name, latitude, and longitude below, and press the 'Add' button. If you don't know the lat/long of a site, click the 'Get my location' button to get your current GPS coordinates, or look up the coordinates of a site of interest on Google maps. Site coordinates will be rounded to the nearest 0.1 decimal degree (approximately 5 miles or 8 km).</p>

<p>Data is available for the upper Midwest US, from 38 to 50&deg; North latitude and from -98 to -82&deg; West longitude. Any subscriptions you have will be automatically enabled on <%= Subscriber.dates_active.first.strftime("%b %-d") %> and disabled on <%= Subscriber.dates_active.last.strftime("%b %-d") %>, but you can enable or disable them at any time.</p>

<div class="location-container">
  <div><button onclick="getGeoLocation()">Get my location</button></div>
  <div id="location-display"></div>
</div>

<h4>Your sites (from North to South):</h4>

<div class="site-box">
  <div class="tbl-container">
    <table>
      <thead>
        <tr>
          <th>Site Name</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th><%= @site_count > 0 ? "Enabled?" : ""%></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @sites.each do |site| %>
          <tr data-site-id=<%= site.id %>>
            <td><%= site.name %></td>
            <td><%= site.latitude %></td>
            <td><%= site.longitude %></td>
            <td>
              <label>
                <div class="toggle-site">
                  <div>
                    <%= check_box_tag "site-toggle-#{site.id}", site.id, site.enabled %>
                  </div>
                  <div id=<%= "site-status-#{site.id}" %>>
                    <%= site.enabled ? "Yes" : "No" %>
                  </div>
                </div>
              </label>
            </td>
            <td>
              <button class="delete-site" id="delete-site-<%= site.id %>">
                <div><%= image_tag("cross.png", class:'delete-cross') %></div>
                <div>Delete</div>
              </button>
            </td>
          </tr>
        <% end %>
        <tr id="add-controls">
          <td><%= text_field_tag "site-name", "", maxlength: 25, size: 25 %></td>
          <td><%= text_field_tag "latitude", "", maxlength: 6, size: 6 %></td>
          <td><%= text_field_tag "longitude", "", maxlength: 6, size: 6 %></td>
          <td><button id="submit-site">Add</button></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<% if @site_count > 0 %>
  <h4>Select your data subscriptions for each site:</h4>

  <div class="site-box">
    <div class="tbl-container">
      <table>
        <thead>
          <tr>
            <th>Site Name</th>
            <% @subs.each do |s| %>
              <th><%= s.name %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @sites.each do |site| %>
            <tr data-site-id=<%= site.id %>>
              <td><%= site.name %></td>
              <% @subs.each do |s| %>
                <td align="center"><%= check_box_tag "sub-toggle-#{s.id}", s.id, site.subscriptions.include?(s) %></td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<div class="site-controls">
  <div><%= link_to("<button>Finish</button>".html_safe, root_path) %></div>
  <% if @site_count > 0 %>
    <div><%= link_to("<button>Disable all sites</button>".html_safe, unsubscribe_subscriber_path(@subscriber.id, token: @subscriber.confirmation_token)) %></div>
    <div><%= link_to("<button id='send-email' disabled>Send test email</button>".html_safe, send_email_subscriber_path(@subscriber.id, token: @subscriber.confirmation_token)) %></div>
  <% end %>
  <% if @admin %>
    <div><%= link_to("<button>Admin</button>".html_safe, admin_subscribers_path) if @admin %></div>
  <% else %>
    <div><%= link_to "<button>Delete my account</button>".html_safe, subscriber_path(@subscriber.id, token: @subscriber.confirmation_token), method: :delete, data: {confirm: "Are you sure you want to delete your account?"} %></div>
  <% end %>
  <div><%= link_to "<button>Log out</button>".html_safe, logout_subscribers_path %></div>
</div>

<%= render partial: "notices" %>
