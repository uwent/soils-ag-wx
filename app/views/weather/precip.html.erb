<% @title = "Precipitation Data" %>
<% @welcome_image = "precip-map-250px.png" %>
<%= javascript_include_tag "map_functions" %>
<% if @is_post %>
  <script>
    elementReady("#map").then(() => { document.getElementById("map").scrollIntoView(); });
  </script>
<% end %>

<% content_for :welcome do %>
  <h2><%= @title %></h2>
  <p>Precipitation data is pulled from gridded daily total precipitation datasets generated by the National Oceanographic and Atmospheric Administration and provided here for easy access.</p>
  <%= render partial: "quick_links" %>
<% end %>

<h2>Gridded Daily Precipitation Data</h2>

<hr>

<p>Use this page to access gridded precipitation data for the upper Midwest. This data is collected daily from NOAA datasets, which are generated from a combination of real-world observations and computer modeling. Data is aggregated to a 0.1 decimal degree scale (roughly 8km E/W by 11km N/S in Wisconsin). Precpitation can be highly localized, so these data may not completely match observations from rain gauges or weather stations, but should be relatively close. Consider checking <%= link_to "weather.gov", "https://www.weather.gov", target: "_blank" %> or <%= link_to "wunderground.com", "https://www.wunderground.com", target: "_blank" %> for weather/precipitation history or forecasts from an individual weather station.</p>
<p>Daily maps in the default units are already rendered by our server and can be browsed quickly. Changing units or using the cumulative map tool below will take around 10 seconds to render the image.</p>

<% if @start_date %>
  <h4 id="map">Cumulative precipitation map for <%= @start_date.strftime("%b %-d") %> to <%= @date.strftime("%b %-d") %> (<%= pluralize((@start_date..@date).count, "day") %>)</h4>
<% else %>
  <h4 id="map">Precipiation map for <%= @date.strftime("%b %-d") %> (<%= pluralize((Date.current - @date).to_i, "day") %> ago)</h4>
<% end %>

<%= render_async url_for(action: :map_image),
  method: "POST",
  data: {
    endpoint: @endpoint,
    id: @date,
    query: { units: @units, start_date: @start_date }.compact,
    caption: "Note: Map color scale is based on min/max daily precipitation across region. Precipitation data is not available for Canada from our data source (NOAA)."
  }.to_json do %>
  <%= render layout: "partials/loading" do %>
    <p>
      Date: <%= @date %><br>
      <% if @start_date %>Start date: <%= @start_date || "Not specified" %><br><% end %>
      Units: <%= @units %>
    </p>
  <% end %>
<% end %>

<div class="two-box">
  <%= render partial: "map_form__browse" %>
  <%= render partial: "map_form__cumulative" %>
</div>

<h4>Get weather data for a single location</h4>
<p>Choose a location and date range then click "Get Data Series". Daily and cumulative precipitation will be displayed in mm and inches. Note: you can click on the map or click the "Get my location" button to set the lat/long.</p>
<%= render partial: "partials/grid_selector", locals: { target: url_for(action: :precip_data) } %>
<div id="map-data"></div>

<h4>Download weather data grid</h4>
<p><%= link_to "Download the entire grid of data for #{@date.strftime("%b %-d")} in CSV format", action: :precip, format: :csv, params: { date: @date } %>. Currently it is only possible to download a daily grid, not a cumulative precipitation grid.</p>

<%= content_for :footer do %>
  <%= link_to "Back", action: :index %>
<% end %>
