<script>
  function goToSite() {
    let path = "<%= site_path %>" + `/${latitude.value},${longitude.value}`
    window.location.href = path
  }
</script>

<%= javascript_include_tag "map_functions" %>

<h2><%= @title %></h2>

<div class="site-row">
  <% if @valid.nil? %>
    <p>No location provided. Please select a location with the form below:</p>
  <% elsif @valid == false %>
    <div class="error">Invalid site specified, try another one.</div>
  <% elsif @valid %>
    <h4>Data for this location:</h4>
    <div class="site-box">
      Site data goes here.
    </div>
  <% end %>
</div>

<div class="site-row">
  <h4>Select a location:</h4>
  <div class="site-box">
    <%= form_tag sites_path do %>
      <div>
        <label><%= select_tag :latitude, options_for_select(latitude_labels, @lat&.to_s || default_latitude) %> Latitude</label>&nbsp;
        <label><%= select_tag :longitude, options_for_select(longitude_labels, @long&.to_s || default_longitude) %> Longitude</label>&nbsp;
        <button type="button" onclick="getGeoLocation()">Get my location</button>&nbsp;
        <span id="geo-loc-msg"></span><br>
        <button type="button" onclick="goToSite()">View selected location</button>
      </div>
    <% end %>
  </div>
</div>

<div class="site-row">
  <h4>Your sites:</h4>
  <div class="site-box">
    <% if @subscriber %>
      <% if @sites %>
        <ul>
          <% @sites.each do |site| %>
            <li><strong><%= site.name %></strong>: <%= site.latitude %>, <%= site.longitude %> - <%= link_to "View site", action: :index, lat: site.latitude, long: site.longitude %></li>
          <% end %>
        </ul>
        <% if @valid && @sites.where(latitude: @lat, longitude: @long).size == 0 %>
          <p>This location is not part of your saved sites. <%= link_to "Add it?", { controller: :subscribers, action: :manage, lat: @lat, long: @long } %></p>
        <% end %>
      <% else %>
        <p>You don't have any sites. Go to the <%= link_to "Subscriber page", controller: :subscribers %> to manage your sites.</p>
      <% end %>
    <% else %>
      <p>You aren't logged in. To save locations and easily view data or receive email updates, visit the <%= link_to "subscribers page", controller: :subscribers %>.
    <% end %>
  </div>
</div>
